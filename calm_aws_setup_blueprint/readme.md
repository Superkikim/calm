# AWS CentOS Calm Setup
This git contains a Calm blueprint. For the moment being, if the setup failed at some point, the object created will not be deleted. You have to deleted it manually. This will be address in a future version of the Blueprint.

> Disclaimer: When using AWS, be careful not to leave unused resources. These can be costly. These script and blueprint allow to create resources but does not yet delete them after usage. However, the instance used for setup is terminated and the IP is released. When you have finished with your labs, be sure to delete all unused resources on your AWS account. I'm in no way responsible for any AWS charges subsequent to the usage of these script or blueprint.

## Prerequisite
* An Amazon Account
* An IAM user with AmazonEC2FullAccess, AmazonVPCFullAccess, IAMFullAccess
* A Nutanix Cluster with Prism Central 5.10.x and Calm

## BluePrint purpose and features
The goal of this BluePrint is to automate [KB5202](https://portal.nutanix.com/#/page/kbs/details?targetId=kA00e000000Xf9rCAC).

Once launched, a CentOS virtual machine will be deployed as administration interface to run script and create the environments on AWS and accounts in Calm. It will then allow to create multiple AWS environments following KB5202.

### Features
* Administration Linux VM with Python3 and boto3 to interface with AWS

Then, for each project:

* Automatic creation or deletion of AWS Linux CentOS Up to date image
* Automatic creation or deletion of AWS IAM users
* Automatic registration or removal of accounts in Calm
* Automatic configuration and removal of VPC, and security groups for each project
* Multiple project management

### Blueprint credentials:
* Credentials name: admin_cred
* Username: Of your choice
* Secret: Key
* Private Key: Of your choice

## Blueprint Services
This blueprint contains a single VM service. This VM will be setup from the [CentOS generic cloud image](https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2) from the CentOS website. The requires packages to interface with AWS are installed and all the next scripts are run against this virtual machine.

### admin service
The admin service is the administration virtual machine for the blueprint. It will use as user the variable admin_cred.username.

#### Variables
The admin service contains following variables

* Runtime variables
  * admin_cred.username: will be used as administrator user for the virtual machine
  * admin_cred.secret: will contain the private key for the admin_cred.username user
  * admin.rootpassword: Will be used to set the admin VM root password
  * admin.ssh_key: The public key for the blueprint admin_cred user

* Prepopulated variables
  * admin.sshgroup: Will be the name of the SSH group allowed to access the admin VM from ssh

* Self populated variables
  * admin.pc_ip: Will be used to store Prism Central IP address
  * admin.public_ip: Will be the Internet IP address of the environment

  |Name|Value|Type|Secret|Runtime|Description|
  |---|---|---|:---:|:---:|---|
  |admin_cred.username|[Linux user]|string|False|True|Linux user to login to the admin service|
  |admin_cred.secret|[Private key]|string|True|True|Private key for the admin service user|
  |admin.ssh_key|[SSH Public key]|string|False|True|SSH key for the admin service user|
  |admin.sshgroup|sshusers|string|False|False|Allowed users will be added to the group|
  |admin.rootpassword|[Password for root]|string|True|True|Will be set as root password in the admin service|
  |admin.pc_ip|[Prism Central IP]|string|False|False|IP address for Prism Central, autopopulated|
  |admin_public_ip|[Public IP]|string|False|False|Public IP of the gateway from admin service to Internet|

#### Actions
The admin service contains the following actions

##### Action create
Action create will:
* Set the virtual machine hostname to the virtual machine name generated by Calm
* Change root password to admin.rootpassword
* Configure SSH to allow only members of the admin.sshgroup group, and add admin_cred.username in the group. It will allow disallow root login and password authentication
* Lockdown firewall to allow only HTTP, HTTPS, SSH and DNS traffic
* Parse Prism Central and Internet public IP addresses and populate admin.pc_ip and admin.public_ip variables

##### Package Install
Package Install will install following packages on the virtual machine
* nano as text editor if you don't like vim
* htop for processes monitoring in case you want to see what is happening on the VM
* epel, required to install python
* python and pip required for boto
* boto v2 which is a python module to interface with AWS
* wget used to get internet address
* netaddr used to validate subnets and CIDRs

##### Stop Service
This action is automatically called when the service is deleted. The Stop Service action will remove every existing AWS setup made from this blueprint. This allows to ensure that when the service is deleted, there will not be forgotten items on AWS which could be costly.

this action will:
* Deregister all AMIs created from the Blueprint
* Delete all keypairs generated from the Blueprint
* Delete VPCs and all dependencies
* Delete IAM Roles created from this Blueprint
* Delete IAM users created from this blueprint
* Delete AWS entries created by the blueprint in Calm

Caveats: The AWS entries in Calm will not be deleted if the Prism Central credentials have changed between creating and deletion of the project

## Blueprint actions
Once the blueprint has been launch and the application is provisioned, the following actions will be available
* Action Create Project
* Action List Projects
* Action Delete Project
* Action activate IAM key
* Action Deactivate IAM key

Each action is described below

### Action Create project
The action "Create Project" will configure an AWS environment according to KB5202 and setup the AWS account in Calm. In order to allow multiple users to get each their own environment, of a single user to generate multiple environment for multiple projects, the action can be run multiple time. Every occurrence will save all variables.

This means, the action can be triggered multiple times to create multiple projects.

#### Variables
|Name|Value|Type|Secret|Runtime|Description|
|---|---|---|:---:|:---:|---|
|project_name|[project_name]|string|False|True|A name for the project. This name must be unique|
|aws_access_key_id|[AWS access key ID]|string|False|True|AWS Access key for the main IAM AWS user. Keys must be active at project creation time|
|aws_secret_access_key|[AWS secret access key]|string|True|True|AWS Secret access key for the prerequisite IAM user|
|region|eu-west-2|string|False|True|Region to deploy the environment|
|cidr|10.0.0.1/16|string|False|True|CIDR for the VPC|
|subnet|10.0.10.0/24|string|False|True|Subnet for the deployment of VMs. This can be any subnet range fitting within the CIDR|
|ami_id|ami-ee6a718a|string|False|True|This is the AMI ID from Amazon Marketplace, to create the CentOS Instance. This needs to be set to the right AMI ID for the region that has been selected. The list of CentOS AMI IDs can be found [here](https://wiki.centos.org/Cloud/AWS)|
|instance_type|t2.micro|string|False|False|The type of instance used to create the customer CentOS AMI |
|tcp_ports|22,80,443,53|string|False|True|The list of TCP ports you want to have opened in the security group, comma separated|
|udp_ports|53|string|False|True|The list of UDP ports you want to have opened in the security group, comma separated|
|pc_user|[Prism Central User]|string|False|True|Prism Central user. This user must be allowed to configure Calm|
|pc_password|[Prism Central password]|string|True|True|Password for the above user|

#### Tasks
The following tasks will be triggered for each project:

* A flat file will be created to save the variables for the specific project
* An AWS role will be created
* An AWS user will be created
  * AWS user IAM keys will be generated and deactivated for security reasons
  * A user policy will by created and assigned to the user according to KB5202
  * An AWS entry will be created in Calm with the created user and key
* A VPC will be created for the project
  * The CIDR and subnets will be validated to ensure the subnet fits is inside the CIDR
* The required subnet will be created
* A security group will be created
  * the requested ports will be opened
* An SSH key pair will be created for the project
* A CentOS instance will be created and run
  * In this instance, CentOS will be upgraded
  * From that instance, an AMI will be created for the projects
  * The instance will then be stopped and destroyed leaving the AMI available for the project

### Action List Projects
This action allows to list the existing projects in the script output
#### Variables
None
#### Tasks
* Get the list of existing projects in the application. The list can be viewed in the script output

### Action activate IAM key
This action allow to activate an IAM key for a specific project
#### Variables
|Name|Value|Type|Secret|Runtime|Description|
|---|---|---|:---:|:---:|---|
|project_name|[Project name]|string|False|True|The project name for which the IAM key need to be activated|

### Action deactivate IAM key
This action allows to deactivate an IAM key for a specific project
#### Variables
|Name|Value|Type|Secret|Runtime|Description|
|---|---|---|:---:|:---:|---|
|project_name|[Project name]|string|False|True|The project name for which the IAM key need to be deactivated|

### Action Delete Project
This action will delete a project and all dependencies.

Caveats: The AWS entries in Calm will not be deleted if the Prism Central credentials have changed between creating and deleting the project

#### Variables
|Name|Value|Type|Secret|Runtime|Description|
|---|---|---|:---:|:---:|---|
|project_name|[Project name]|string|False|True|The project name for which the IAM key need to be activated|

#### Tasks
This action will trigger following tasks:
* Deregister the AMI created for the project
* Delete the related key pair
* Delete the VPC and all dependencies (Subnet, Security group)
* Delete the IAM user and role created for the project
* Delete the AWS Entry in Calm. Note that this will be done using the Prism Central cr

## Version history:
Version number is aligned with the source Calm version.

### 5.10.0.1
Known limitations:
* Variables are not all tested before execution. If a variable is not valid, the tasks will stop at the use point, and all the previous tasks will have been executed anyway. Next release improvement would be to validate all variables at start, and then proceed to all tasks for a specific action.

Improvements:
* Added validation routines and error messages
* Implemented multi-project features
  * Create or delete specific project
  * List Projects
  * Delete all projects upon application deletion
* Automate Calm AWS entry management
* Added multi protocol and multi port security group configuration
* Automatically deactivate IAM users for project at creation
* Added activate and deactivate IAM key for security purpose

### 5.7.0.1:
* The IAM secret key is made inactive for security reason,
* the AWS account is automatically created in Calm
